# VARCHAR vs TEXT

## 공통점
- 문자열 속성 저장
- 최대 65355 bytes까지 저장 가능

<br>

## 차이점
- TEXT 타입은 VARCHAR처럼 최대 길이를 지정하지 않으며, 고정된 최대 크기를 기준으로 데이터를 저장
- TEXT 타입 컬럼은 인덱스 생성 시 반드시 prefix 길이를 지정해야 인덱스 생성이 가능하고, 그렇지 않으면 생성 불가
  + 물론 인덱스 키로 지정할 수 있는 최대 사이즈를 넘어가는 크기로 길이를 지정하면 인덱스 생성 불가. 이는 VARCHAR도 마찬가지
- TEXT 타입 칼럼은 표현식으로만 디폴트 값 지정 가능

<br>

## 일반적인 사용 형태
- 길이가 짧으면 VARCHAR, 길면 TEXT -> 이는 기준이 상대적이고 명확한 기준이 있지 않음

### VARCHAR와 TEXT의 메모리 활용
- MySQL에서는 세션에서 어떤 테이블에 저장된 데이터를 읽는다고 할 때 메모리에 이를 위한 버퍼 공간을 미리 할당해두고 그걸 유지하면서 재활용한다.
- 이때 버퍼 공간은 실제 레코드의 데이터 크기에 관계 없이 최대 크기로 메모리를 할당해두며, VARCHAR칼럼의 경우 이 공간에 포함되어 메모리 공간을 제사용 가능
- TEXT 데이터의 경우 실제 최대 크기만큼 메모리를 할당해 두면 메모리 낭비가 너무 심해져 TEXT 컬럼을 위한 공간은 포함되지 않는다.
  - 따라서 매번 레코드를 읽고 쓸 때마다 필요한 만큼 메모리가 할당되고 해제 되어야 한다.
- **결론** : 만약 컬럼 사용이 빈번하고 서버의 메모리 용량도 충분하다면 VARCHAR 타입을 사용하는 것 권장

#### + VARCHAR 최대 길이 설정
- 앞서말했듯이 메모리의 버퍼 공간을 할당할 때 VARCHAR 컬럼도 포함해서 컬럼에 지정된 최대 길이만큼 메모리 공간을 할당한다.
- 따라서 관성적으로 30, 255 등으로 설정하지 말고 실제 최대 사용하는 길이만큼을 고려해서 설정 하는 것이 좋다.
- 길이 저장을 위한 바이트 차이도 미미하지만 영향을 줄 수 있다

### VARCHAR와 TEXT의 Row 사이즈 제한
- VARCHAR 컬럼이 테이블에 많이 존재하는 경우 로우 사이즈 제한에 걸릴 수 있게 된다.
- TEXT나 BLOB와 같은 LOB 컬럼은 이 제한 사항에 거의 영향을 미치지 않는다.
- **결론** : 그래서 많은 컬럼을 가진 테이블에서는 VARCHAR 타입 대신 TEXT 타입을 적절하게 사용해야 할 수도 있다.

<br>

## VARCHAR와 TEXT 주의사항

### 데이터 크기가 매우 커지는 경우
- 일반적인 RDBMS에서와 같이, MySQL 서버도 레코드의 컬럼 데이터는 B-Tree (Clustering Index)에 저장(이를 Inline 저장이라고 함)한다.
- 하지만 용량이 큰 LOB 데이터는 B-Tree 외부의 Off-Page 페이지(MySQL 서버 메뉴얼에서는 External off-page storage라고 해요)로 저장.
  + MySQL 서버의 레코드 크기 제한은 65,535 바이트이지만, InnoDB 스토리지 엔진의 레코드 크기 제한은 페이지(블록)의 크기에 따라서 달라지는데, 대부분 페이지 크기의 절반이 InnoDB 스토리지 엔진의 최대 레코드 크기 제한으로 작동
  + InnoDB 스토리지 엔진은 레코드의 전체 크기가 이 제한 사항(16KB 페이지에서는 8,117 바이트)을 초과하면 길이가 긴 컬럼을 선택해서 Off-Page로 저장
  + 기준이 있다 는 것 까지 알아두고 외우지 말자
- 실제 다른 컬럼들이 모두 저장되어 있는 본래의 데이터 페이지에는 외부 페이지를 가리키는 바이트 포인터 값만 저장
- TEXT 타입과 VARCHAR 타입 컬럼 모두 동일하게 적용되는 현상이다
- 이 현상에 쿼리에서 주의할 점이 생긴다
- **쿼리에서 off-page칼럼의 참조 여부에 따라 쿼리 처리 성능이 매우 달라진다**
  - 보통 where절에서 이 같은 대형 칼럼을 조건으로 참조하는 경우는 드물다
  - select절에서 참조하고 또 관성적으로 테이블의 모든 칼럼들을 조회하는 경우가 많은데 이 때 off-page로 저장된 큰 사이즈의 칼럼 데이터를 조회하면 성능이 매우 저하되므로, 필요없는 경우 제외해야 한다


## 참고

https://medium.com/daangn/varchar-vs-text-230a718a22a1

